<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="author" content="Co-authored: Brian Wong, Justin Tsuchiyama, Tyler Luk">
    <meta name="description" content="Website to schedule stuff.">
    <link href="styles/styles.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="images/CalendarIcon.ico">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">  
    <title>Scheduler</title>

    <!-- CALENDAR STUFF -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.6.0/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.6.0/main.min.js'></script>

  </head>
  <body>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <script>
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      var firebaseConfig = {
        apiKey: "AIzaSyC1rvN3zf0_W9Vz_oq-TTFY6-g5-XyyXOY",
        authDomain: "schdlr-b3435.firebaseapp.com",
        projectId: "schdlr-b3435",
        storageBucket: "schdlr-b3435.appspot.com",
        messagingSenderId: "787536569268",
        appId: "1:787536569268:web:1f2966c2622f1a347a48e1",
        measurementId: "G-95FKY6HTYT"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      var db = firebase.firestore();
      firebase.analytics();
      
    </script>
    <script src="scripts/User.js"></script>
    <script src="scripts/main.js"></script>


    <!-- Navbar -->
    <nav class="navbar navbar-inverse">
      <div class="container-fluid">
        <div class="navbar-header active">
          <a class="navbar-brand" href="#">Scheduler</a>
        </div>
        <ul class="nav navbar-nav">
          <li><a href="profile.html">Profile</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li><a href="index.html" onclick="signOut()"><span class="glyphicon glyphicon-log-out"></span> Sign Out</a></li>
        </ul>

        <!-- Search Bar -->
        <div class="dropdown nav navbar-nav navbar-right">
          <button onclick="searchDropdown()" class="dropbtn">Search</button>
          <div id="myDropdown" class="dropdown-content">
            <input type="text" placeholder="Search.." id="myInput">
            <ul class="list-group" id="peopleList"></ul>
          </div>
        </div>


      </div>
    </nav>

    <!-- Content -->
    <div class="content">
      <div id="createEventSection" style="display: none;">
        <button type="button" onclick="executeBusyList()" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
          Create Event
        </button>

        <!-- This is the Create Event Modal-->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="myModalLabel" style="font-size: 25px; font-weight: bold;">Create Event!</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
                <div class="modal-body">
                  <form onsubmit="createSchedulerEvent();return false">

                    <div class="container-fluid">
                      <div class="row">
                        
                        <!-- Event Details Column -->
                        <div class="col-sm-4">
                          <div class="form-group">
                            <label for="eventName">*Event Name:</label>
                            <input type="text" class="form-control" id="eventName" placeholder="Title" required>
                          </div>
                          <div class="form-group">
                            <label for="startdateTime">*Start Time:</label>
                            <input type="datetime-local" class="form-control" id="startdateTime" required>
                          </div>
                          <div class="form-group">
                            <label for="enddateTime">*End Time:</label>
                            <input type="datetime-local" class="form-control" id="enddateTime" required>
                          </div>
                          <div class="form-group">
                            <label for="description">Event Description:</label>
                            <input type="text" class="form-control" id="eventDescription" placeholder="Describe it">
                          </div>
                          <div class="form-group">
                            <label for="eventLocation">Event Location:</label>
                            <input type="text" class="form-control" id="eventLocation" placeholder="Where it at?">
                          </div>
                          <p class="giveBorder" id="friendsInEvents"></p>
                          <div class="form-group">
                            <input type="text" onclick="textBoxDropdown()" placeholder="Search for friends..." id="textBoxInput">
                            <ul class="list-group" id="friendList"></ul>
                          </div>
                        </div>
                        <!-- Calendar Column -->
                        <div class="col-sm-8">
                          <p>*Highlight date and time for event. Red zones are when invitees are busy.</p>
                          <div class="fitCalendar">
                            <div id="overlapCalendar"></div>
                          </div>
                        </div>
                      
                      
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                      <button type="submit" class="btn btn-primary">Create</button>
                    </div> 
                  </form>
                </div>
            </div>
          </div>
        </div>

        <hr>
      </div>

      <!--Add button to initiate auth sequence -->
      <button id="authorize_button" class="btn btn-primary btn-lg" style="display: none; margin-bottom: 20px;">Authorize</button>

      <!-- CALENDAR STARTS HERE -->
      <div class="calendarContainer">
        <div id='calendar'></div>
      </div>

      <!--Add button to initiate signout -->
      <button id="signout_button" class="btn" style="display: none; margin-bottom: 90px; margin-top: 20px; float: right;">Sign Out</button>




      <!-- SCRIPT FOR CALENDAR HERE -->
      <script type="text/javascript">
        // Client ID and API key from the Developer Console
        var CLIENT_ID = '787536569268-elefuvio2stdcvvn58aociq5ijb84t6t.apps.googleusercontent.com';
        var API_KEY = 'AIzaSyC1rvN3zf0_W9Vz_oq-TTFY6-g5-XyyXOY';

        // Array of API discovery doc URLs for APIs used by the quickstart
        var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

        // Authorization scopes required by the API; multiple scopes can be
        // included, separated by spaces.
        var SCOPES = "https://www.googleapis.com/auth/calendar";

        var authorizeButton = document.getElementById('authorize_button');
        var signoutButton = document.getElementById('signout_button');
        var createEventSection = document.getElementById('createEventSection');
        /**
         *  On load, called to load the auth2 library and API client library.
         */
        function handleClientLoad() {
          gapi.load('client:auth2', initClient);
        }

        function passFirebaseUser(firebase) {
          console.log("Passing firebase user to home.html");
          console.log("should not b undefined: "+firebase);
          firebaseUser = firebase;
        }

        /**
         *  Initializes the API client library and sets up sign-in state
         *  listeners.
         */
        var auth2;
        function initClient() {
          auth2 = gapi.client.init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            discoveryDocs: DISCOVERY_DOCS,
            scope: SCOPES
          }).then(function () {
            // Listen for sign-in state changes.
            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

            // Handle the initial sign-in state.
            updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            authorizeButton.onclick = handleAuthClick;
            signoutButton.onclick = handleSignoutClick;

          }, function(error) {
            appendPre(JSON.stringify(error, null, 2));
          });
        }

        function onFailure() {
          console.log("Failed to storeCalendarID");
        }

        function storeCalendarID() {
          var user = gapi.auth2.getAuthInstance().currentUser.get();
          var profile = user.getBasicProfile();
          var calendarID = profile.getEmail();

          // Now add this to user object
          db.collection('users').doc(firebaseUser.uid).update({
            calendarID: calendarID
          });
          return calendarID;
        }

        function removeCalendarID() {
          // Set calendarID to empty string
          console.log("removing calendar ID");
          db.collection('users').doc(firebaseUser.uid).update({
            calendarID: ""
          });
        }

        /**
         *  Called when the signed in status changes, to update the UI
         *  appropriately. After a sign-in, the API is called.
         */
        function updateSigninStatus(isSignedIn) {
          var calendarEl = document.getElementById('calendar');
          var calendarID, calendar;
          if (isSignedIn) {
            auth2.then(calendarID = storeCalendarID(), onFailure).then(function() { 
              console.log("Google Calendar ID: " + calendarID);
              eventFriendsEmailsList.push(calendarID);
              eventFriendsUidList.push(firebaseUser.uid);
              console.log("Calendar ID: " + calendarID);
              authorizeButton.style.display = 'none';
              signoutButton.style.display = 'block';
              createEventSection.style.display = 'block';

              //Create a calendar with users events
              console.log("User calendar");
              calendar = new FullCalendar.Calendar(calendarEl, {
                aspectRatio: 1.9,
                headerToolbar: { 
                  start: 'today prev,next',
                  center: 'title',
                  end: 'dayGridMonth,timeGridWeek' 
                },
                googleCalendarApiKey: 'AIzaSyC1rvN3zf0_W9Vz_oq-TTFY6-g5-XyyXOY',
                initialView: 'dayGridMonth',
                events: {
                  googleCalendarId: calendarID
                }
              });
              calendar.render();
            });
          } else {
              // include text here
              authorizeButton.style.display = 'block';
              signoutButton.style.display = 'none';
              createEventSection.style.display = 'none';

              // Default calendar
              console.log("Default calendar");
              calendar = new FullCalendar.Calendar(calendarEl, {
                aspectRatio: 1.9,
                headerToolbar: { 
                  start: 'today prev,next',
                  center: 'title',
                  end: 'dayGridMonth,timeGridWeek' 
                },
                initialView: 'dayGridMonth'
              });
              calendar.render();
              auth2.then(removeCalendarID(), onFailure);
          }
        }

        /**
         *  Sign in the user upon button click.
         */
        function handleAuthClick(event) {
          gapi.auth2.getAuthInstance().signIn();
        }

        /**
         *  Sign out the user upon button click.
         */
        function handleSignoutClick(event) {
          gapi.auth2.getAuthInstance().signOut();
        }

        /**
         * Append a pre element to the body containing the given message
         * as its text node. Used to display the results of the API call.
         *
         * @param {string} message Text to be placed in pre element.
         */
        function appendPre(message) {
          var pre = document.getElementById('calendar');
          var textContent = document.createTextNode(message + '\n');
          pre.appendChild(textContent);
        }

      </script>

      <script async defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
      </script>
          

    </div>

    <footer>
      <p>©Copyright 2050 by nobody. All rights reversed.</p>
    </footer>
  </body>
</html> 
